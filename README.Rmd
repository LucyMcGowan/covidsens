---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# covidsens

<!-- badges: start -->
<!-- badges: end -->

The goal of covidsens is to calculate the test sensitivity and probability of missing a COVID-19 infection on a given day post-exposure.

## Installation

<!-- You can install the released version of covidsens from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("covidsens") -->
<!-- ``` -->

You can install the development version of covidsens from GitHub with:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("LucyMcGowan/covidsens")
```


## Example

Plot the false negative rate by days since crossing the detection threshold.

```{r fig1}
library(covidsens)
library(ggplot2)

d <- data.frame(
  x = seq(0, 14, by = 0.1),
  fnr = get_fnr(seq(0, 14, by = 0.1))
)

ggplot(d, aes(x, fnr)) +
  geom_line() +
  geom_vline(xintercept = 0, lty = 2) +
  theme_minimal() +
  scale_x_continuous("Days since crossing the threshold", breaks = 0:14) +
  labs(x = "Days since crossing the dection threshold",
       y = "1 - Sensitivity") 
```

Calculate the probability of missing an infection if a test sample is collected 48 hours prior to quarantine exit.

```{r example, message = FALSE, warning = FALSE}
d <- data.frame(
  p = purrr::map_dbl(0:14, get_prob_missed_infection, additional_quarantine_time = 2),
  t = 0:14,
  qt = 2:16,
  p2 = plnorm(0:14, 1.63, 0.5, lower.tail = FALSE))

ggplot(d, aes(x = qt, y = p)) +
  geom_line() +
  geom_line(aes(x = t, y = p2), lty = 2) + 
  scale_x_continuous(breaks = 0:14, limits = c(0, 14)) +
  geom_hline(yintercept = c(0.089, 0.022), lty = 3) +
  theme_minimal() +
  labs(x = "Days from exposure to quarantine exit",
       y = "Proportion of infections missed")
```

Calculate the probability of missing an infection on a given test day with additional quarantine days.

```{r fig2, message = FALSE, warning = FALSE}
vals <- expand.grid(
  t = c(0, 3, 5, 7, 10),
  s = seq(0, 14, 0.1)
)
vals$p <- purrr::map2_dbl(vals$t, vals$s, get_prob_missed_infection)
vals$qt <- vals$t + vals$s
test_date <- vals[vals$s == 0, ]

ggplot(vals, aes(x = qt, y = p, color = as.factor(t))) +
  geom_line() +
  geom_line(aes(x = qt, y = plnorm(qt, 1.63, 0.5, FALSE)), color = "black", lty = 2) +
  scale_x_continuous(breaks = 0:14, limits = c(0, 14)) +
  geom_hline(yintercept = c(0.089, 0.022), lty = 3) +
  geom_point(data = test_date, aes(x = t, y = p)) +
  theme_minimal() +
  labs(x = "Days from exposure to quarantine exit",
       y = "Proportion of infections missed",
       color = "Day test sample \nwas collected") +
  theme(panel.grid.minor = element_blank(),
        legend.position = "bottom") 
```

Stochastic

```{r, eval = FALSE}
library(tidyverse)
n <- 100
params <- tibble(
  id = 1:n,
  shape_fnr = rnorm(n, 2.33, 1.86),
  rate_fnr = rnorm(n, 0.24, 0.21),
  shape_exposure_to_threshold = rnorm(n, 2.16, 1.25),
  shape_threshold_to_symptoms = rnorm(n, 1.98, 1.33),
  rate = rnorm(n, 0.72, 0.1)
) %>%
  mutate(shape_fnr = ifelse(shape_fnr < 1, 1, shape_fnr),
         rate_fnr = ifelse(rate_fnr < 0.1, 0.1, rate_fnr),
         shape_exposure_to_threshold = ifelse(shape_exposure_to_threshold < 0.1, 0.1, shape_exposure_to_threshold),
         shape_threshold_to_symptoms = ifelse(shape_threshold_to_symptoms < 0.1, 0.1, shape_threshold_to_symptoms), 
         rate = ifelse(rate < 0.1, 0.1, rate))
vals <- expand_grid(
  test_time = c(0, 3, 5, 7, 10),
  additional_quarantine_time = 0:14,
  id = 1:n
) %>%
  left_join(params, by = "id") %>%
  select(-id)

vals$p <- pmap_dbl(vals, get_prob_missed_infection)

vals$qt <- vals$test_time + vals$additional_quarantine_time
test_date <- vals[vals$additional_quarantine_time == 0, ]
p <- vals %>%
  group_by(test_time, qt) %>%
  summarise(
     med = median(p),
    lcl = quantile(p, 0.025),
    ucl = quantile(p, 0.975),
    .groups = "drop_last"
  )
ggplot(p, aes(x = qt, y = med, color = as.factor(test_time), fill = as.factor(test_time))) +
  geom_line() +
  geom_ribbon(aes(ymin = lcl, ymax = ucl), alpha = 0.25, color = NA) +
  geom_line(aes(x = qt, y = plnorm(qt, 1.63, 0.5, FALSE)), color = "black", lty = 2) +
  scale_x_continuous(breaks = 0:14, limits = c(0, 14)) +
  geom_hline(yintercept = c(0.089, 0.022), lty = 3) +
 # geom_point(data = test_date, aes(x = test_time, y = p)) +
  theme_minimal() +
  labs(x = "Days from exposure to quarantine exit",
       y = "Proportion of infections missed",
       color = "Day test sample \nwas collected") +
  theme(panel.grid.minor = element_blank(),
        legend.position = "bottom") 
```

